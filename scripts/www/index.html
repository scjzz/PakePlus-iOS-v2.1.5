<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFDE00">
    <meta name="filename" content="beast_transfer_v3.html">
    <title>BeastTransfer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'head': ['"Archivo Black"', 'sans-serif'],
                        'body': ['"Space Grotesk"', 'sans-serif'],
                    },
                    colors: {
                        'pop-yellow': '#FFDE00',
                        'pop-blue': '#3B82F6',
                        'pop-pink': '#FF69B4',
                        'pop-purple': '#8B5CF6',
                        'pop-white': '#FFFFFF',
                        'pop-black': '#121212',
                        'pop-green': '#10B981',
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #121212',
                        'hard-deep': '8px 8px 0px 0px #121212',
                        'hard-sm': '2px 2px 0px 0px #121212',
                        'inner-hard': 'inset 3px 3px 0px 0px rgba(0,0,0,0.1)',
                    },
                    backgroundImage: {
                        'dots': 'radial-gradient(#121212 1px, transparent 1px)',
                    },
                    animation: {
                        'bounce-slight': 'bounce-slight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'radar-spin': 'spin 4s linear infinite',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        'bounce-slight': {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.2)' },
                        },
                        'fadeIn': {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* å…¨å±€æ ·å¼è¦†ç›– */
        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Space Grotesk', sans-serif;
            /* ç¦æ­¢ç³»ç»Ÿé»˜è®¤èœå•å’Œé€‰æ‹© */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }

        /* æ‰‹æœºå¤–å£³å®¹å™¨ */
        .phone-frame {
            width: 100%;
            max-width: 450px;
            height: 100vh;
            max-height: 900px;
            background: #fff;
            border: 8px solid #121212;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            box-shadow: 20px 20px 0px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            /* é€‚é…åˆ˜æµ·å± */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        @media (max-width: 500px) {
            .phone-frame {
                max-width: 100vw;
                height: 100vh;
                max-height: 100vh;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
        }

        /* è¾“å…¥æ¡†å…è®¸é€‰æ‹© */
        input, code, textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* æ¼«ç”»é£æ ¼ç½‘ç‚¹èƒŒæ™¯ */
        .comic-dots {
            background-image: radial-gradient(#d1d5db 2px, transparent 2px);
            background-size: 20px 20px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #121212;
            border-radius: 3px;
        }

        /* æŒ‰é’®äº¤äº’ */
        .btn-press {
            transition: all 0.1s;
            cursor: pointer;
            touch-action: manipulation;
        }
        .btn-press:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px 0px #121212 !important;
        }

        /* åº•éƒ¨å¯¼èˆªç‰¹æ®Šæ ·å¼ */
        .nav-item.active {
            background-color: #121212;
            color: #FFDE00;
            transform: translateY(-5px) rotate(-3deg);
            box-shadow: 4px 4px 0px #FF69B4;
        }
        .nav-item.active i {
            animation: bounce-slight 0.4s ease-in-out;
        }

        /* é›·è¾¾æ³¢çº¹ */
        .ripple {
            position: absolute;
            border: 4px solid #121212;
            border-radius: 50%;
            opacity: 0;
            animation: ripple-anim 3s infinite linear;
        }
        .ripple:nth-child(2) { animation-delay: 1s; }
        .ripple:nth-child(3) { animation-delay: 2s; }

        @keyframes ripple-anim {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 400px; height: 400px; opacity: 0; }
        }

        .view-section {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            animation: fade-in 0.3s ease-out;
        }
        .view-section.active {
            display: flex;
        }

        /* é’ˆå¯¹ä¸åŒé¡µé¢çš„èƒŒæ™¯è‰²åˆ‡æ¢ */
        .phone-frame.bg-transfer { background-color: #FFDE00; }
        .phone-frame.bg-history { background-color: #3B82F6; }
        .phone-frame.bg-settings { background-color: #8B5CF6; }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ç»Ÿä¸€å¯¼èˆªæ  */
        .bottom-nav {
            position: absolute;
            bottom: calc(1.5rem + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: white;
            border: 4px solid #121212;
            border-radius: 20px;
            height: 5rem;
            box-shadow: 4px 4px 0px 0px #121212;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 0.5rem;
            z-index: 50;
        }
    </style>
</head>
<body>

    <div id="app" class="phone-frame bg-transfer">
        <!-- éšè—çš„æ–‡ä»¶é€‰æ‹©å™¨ -->
        <input type="file" id="file-selector" class="hidden" multiple>
        
        <!-- ä¼ è¾“è¿›åº¦æµ®å±‚ -->
        <div id="transfer-overlay" class="absolute inset-0 z-[100] bg-black/80 flex items-center justify-center p-6 hidden">
            <div class="bg-white border-4 border-black p-4 w-full max-w-[340px] shadow-hard rotate-1 flex flex-col max-h-[80vh]">
                <h3 id="transfer-title" class="font-head text-xl mb-4 uppercase text-center">ä¼ è¾“ä»»åŠ¡</h3>
                
                <!-- æ–‡ä»¶ä»»åŠ¡åˆ—è¡¨ -->
                <div id="transfer-file-list" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1 min-h-[100px]">
                    <!-- åŠ¨æ€ç”Ÿæˆæ–‡ä»¶é¡¹ -->
                </div>

                <!-- æ€»è¿›åº¦ -->
                <div id="total-progress-container" class="pt-3 border-t-4 border-black">
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-body font-bold text-[10px] uppercase opacity-60">æ€»ä½“è¿›åº¦</p>
                        <p id="file-count-text" class="font-body font-bold text-[10px] uppercase opacity-60">0/0</p>
                    </div>
                    <div class="w-full h-4 border-4 border-black bg-gray-200 relative overflow-hidden">
                        <div id="total-progress-bar" class="absolute inset-y-0 left-0 bg-pop-yellow border-r-4 border-black transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p id="transfer-info" class="font-body font-bold text-[10px] mt-2 text-center opacity-60">0% - 0MB / 0MB</p>
                </div>
            </div>
        </div>

        <!-- é¡µé¢ 1: ä¼ è¾“é¦–é¡µ (TRANSFER) -->
        <section id="view-transfer" class="view-section active comic-dots pt-10">
            <!-- æ ‡é¢˜å¤´ -->
            <div class="px-6 pt-4 pb-2 z-10">
                <h1 class="text-5xl font-head text-black leading-[0.9] italic drop-shadow-md">
                     ZAP<br><span class="text-white text-stroke-2" style="-webkit-text-stroke: 2px black;">DROP</span>
                </h1>
                <div class="mt-4 inline-block bg-white border-4 border-black px-3 py-1 -rotate-2 shadow-hard-sm">
                    <span id="lan-mode-status" class="font-body font-bold text-sm text-pop-green">å±€åŸŸç½‘æ¨¡å¼: å¼€å¯</span>
                </div>
            </div>

            <!-- é›·è¾¾ä¸»æ§åŒº -->
            <div class="flex-1 relative flex items-center justify-center overflow-hidden">
                <div id="radar-main-wrapper" class="relative transition-all duration-500 flex items-center justify-center w-full h-full">
                    <!-- åŠ¨æ€æ³¢çº¹ -->
                    <div id="radar-ripples" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                    </div>

                    <!-- ä¸­å¿ƒæŒ‰é’® -->
                    <div id="scan-btn-container" class="relative z-10">
                        <div id="scan-btn" class="w-48 h-48 bg-white border-[6px] border-black rounded-full flex flex-col items-center justify-center shadow-hard-deep btn-press cursor-pointer group">
                            <i data-lucide="zap" class="w-16 h-16 fill-black group-hover:scale-110 transition-transform duration-300"></i>
                            <span id="scan-text" class="font-head text-xl mt-2 tracking-tighter uppercase">æ‰«æ</span>
                            <!-- è£…é¥°æ€§å°æ ‡ç­¾ -->
                            <div class="absolute -right-4 top-0 bg-pop-pink border-4 border-black px-2 py-1 rotate-12 shadow-hard-sm">
                                <span id="scan-status" class="font-bold text-xs text-white">å‡†å¤‡å°±ç»ª!</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸»é¡µå†…è”è®¾å¤‡åˆ—è¡¨ (æ–°) -->
                <div id="homepage-peers-container" class="absolute inset-x-0 bottom-20 px-6 z-20 hidden">
                    <p class="font-head text-[10px] uppercase mb-3 bg-black text-white inline-block px-2 py-1 -rotate-1">å‘¨å›´å¯ç”¨è®¾å¤‡</p>
                    <div id="homepage-peers-list" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                        <!-- åŠ¨æ€ç”Ÿæˆçš„è®¾å¤‡å¡ç‰‡ -->
                    </div>
                </div>

                <!-- è‡ªåŠ¨å‘ç°åˆ—è¡¨åŒºåŸŸ (åˆå§‹éšè—) -->
                <div id="id-input-container" class="absolute z-20 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-[340px] hidden">
                    <div class="bg-white border-4 border-black p-4 shadow-hard -rotate-1 max-h-[60vh] flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <p class="font-head text-sm uppercase text-red-500">æœªå‘ç°è®¾å¤‡</p>
                            <button id="connect-cancel-btn" class="w-8 h-8 border-2 border-black bg-gray-100 flex items-center justify-center btn-press">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        
                        <p class="text-[10px] font-body text-gray-500 mb-4 italic">
                            æœç´¢ä¸€åˆ†é’Ÿæœªå‘ç°å¯ç”¨è®¾å¤‡ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨è¾“å…¥ ID è¿æ¥ã€‚
                        </p>

                        <div class="pt-3 border-t-2 border-dashed border-black">
                            <p class="text-[9px] font-body text-gray-400 uppercase mb-2">æ‰‹åŠ¨è¾“å…¥ ID:</p>
                            <div class="flex gap-2">
                                <input type="text" id="peer-id-input" class="flex-1 border-2 border-black p-1 font-body font-bold text-[10px] focus:outline-none" placeholder="beast-xxxx...">
                                <button id="connect-confirm-btn" class="bg-pop-green text-white font-head px-3 py-1 border-2 border-black shadow-hard-sm btn-press uppercase text-[10px]">è¿æ¥</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-24"></div>
        </section>

        <!-- é¡µé¢ 2: å†å²è®°å½• (HISTORY) -->
        <section id="view-history" class="view-section pt-10">
            <div class="px-6 pt-4 pb-6 flex justify-between items-end border-b-4 border-black bg-white rounded-b-[40px] shadow-hard z-20">
                <div>
                    <h2 class="text-4xl font-head italic">ä¼ è¾“æ—¥å¿—</h2>
                    <div class="text-sm font-bold opacity-60 font-body uppercase">ä»Šæ—¥æ”¶è·</div>
                </div>
            </div>

            <div id="history-list" class="flex-1 overflow-y-auto p-6 space-y-5 comic-dots">
                <div class="flex items-center gap-4">
                    <div class="h-1 flex-1 bg-black"></div>
                    <span class="font-head bg-black text-white px-3 py-1 -rotate-2">ç°åœ¨</span>
                    <div class="h-1 flex-1 bg-black"></div>
                </div>

                <!-- å†å²å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="h-24"></div>
        </section>

        <!-- é¡µé¢ 3: è®¾ç½® (SETTINGS) -->
        <section id="view-settings" class="view-section pt-10">
            <div class="p-6 pt-4">
                <h2 class="text-4xl font-head text-white italic drop-shadow-[4px_4px_0_#000]">è®¾ç½®</h2>
            </div>

            <div class="flex-1 bg-white border-t-[5px] border-black rounded-t-[40px] p-6 space-y-6 overflow-y-auto">
                <div class="border-4 border-black bg-pop-yellow p-4 shadow-hard flex items-center justify-between rotate-1">
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 bg-white border-4 border-black rounded-full overflow-hidden">
                            <img id="my-avatar-img" src="https://picsum.photos/seed/anime1/200" alt="avatar" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h3 id="my-name-display" class="font-head text-xl uppercase">Otaku_01</h3>
                            <div class="bg-black text-white text-[10px] px-2 py-0.5 inline-block font-bold uppercase">åœ¨çº¿</div>
                        </div>
                    </div>
                    <button id="edit-name-btn" class="w-10 h-10 border-4 border-black bg-white flex items-center justify-center shadow-hard-sm hover:translate-y-1 hover:shadow-none transition-all btn-press">
                        <i data-lucide="edit-3" class="w-4 h-4 text-black"></i>
                    </button>
                </div>

                <!-- æˆ‘çš„ ID å±•ç¤º -->
                <div class="border-4 border-black bg-white p-4 shadow-hard -rotate-1">
                    <p class="font-head text-xs mb-2 uppercase text-gray-400">æˆ‘çš„ä¼ è¾“ ID</p>
                    <div class="flex items-center gap-2">
                        <code id="my-peer-id" class="flex-1 bg-gray-100 p-2 font-body font-bold text-xs border-2 border-black truncate">æ­£åœ¨åˆå§‹åŒ–...</code>
                        <button id="copy-id-btn" class="w-10 h-10 border-4 border-black bg-pop-yellow flex items-center justify-center shadow-hard-sm btn-press">
                            <i data-lucide="copy" class="w-4 h-4 text-black"></i>
                        </button>
                    </div>
                    <p class="font-body text-[10px] mt-2 text-gray-500 italic">å‘é€æ­¤ ID ç»™å¥½å‹å³å¯å»ºç«‹å±€åŸŸç½‘ P2P è¿æ¥</p>
                </div>

                <div class="space-y-4">
                    <p class="font-head text-sm uppercase text-gray-400">å¯è§æ€§</p>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-lg font-head">éšèº«æ¨¡å¼</span>
                        <button id="stealth-mode-toggle" class="toggle-switch w-16 h-8 bg-black rounded-full relative border-2 border-black transition-colors duration-300 group" data-active="false">
                            <div class="toggle-knob absolute left-1 top-1 w-5 h-5 bg-pop-pink border-2 border-black rounded-full transition-all"></div>
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="font-bold text-lg font-head">è‡ªåŠ¨ä¿å­˜</span>
                        <button id="auto-save-toggle" class="toggle-switch w-16 h-8 bg-pop-yellow rounded-full relative border-2 border-black" data-active="true">
                            <div class="toggle-knob absolute right-1 top-1 w-5 h-5 bg-white border-2 border-black rounded-full shadow-sm transition-all"></div>
                        </button>
                    </div>
                </div>

                <div class="w-full h-1 bg-gray-200 my-4"></div>

                <button id="storage-path-btn" class="w-full py-4 border-4 border-black bg-white shadow-hard font-head text-lg flex items-center justify-center gap-2 btn-press hover:bg-gray-50">
                    <i data-lucide="folder-open" class="w-5 h-5"></i>
                    å­˜å‚¨è·¯å¾„
                </button>

                <div class="text-center mt-6 opacity-50">
                    <p class="font-head text-xs uppercase">ç‰ˆæœ¬ 1.0.0 æµ‹è¯•ç‰ˆ</p>
                </div>
            </div>
            <div class="h-24"></div>
        </section>

        <!-- ç»Ÿä¸€å¯¼èˆªæ  -->
        <div class="bottom-nav">
            <button onclick="switchView('transfer')" class="nav-item active w-14 h-14 rounded-xl flex flex-col items-center justify-center transition-all" data-view="transfer">
                <i data-lucide="send" class="w-6 h-6 stroke-[3px]"></i>
            </button>
            <button onclick="switchView('history')" class="nav-item w-14 h-14 rounded-xl flex flex-col items-center justify-center opacity-50 hover:opacity-100 transition-all" data-view="history">
                <i data-lucide="clock" class="w-6 h-6 stroke-[3px]"></i>
            </button>
            <button onclick="switchView('settings')" class="nav-item w-14 h-14 rounded-xl flex flex-col items-center justify-center opacity-50 hover:opacity-100 transition-all" data-view="settings">
                <i data-lucide="settings-2" class="w-6 h-6 stroke-[3px]"></i>
            </button>
        </div>

        <!-- è‡ªå®šä¹‰æ³¢æ™®é£æ ¼å¼¹çª— (Custom Dialog) -->
        <div id="custom-dialog" class="absolute inset-0 z-[200] bg-black/60 flex items-center justify-center p-6 hidden">
            <div class="bg-white border-4 border-black p-6 w-full max-w-[300px] shadow-hard rotate-1 flex flex-col">
                <h3 id="dialog-title" class="font-head text-lg mb-2 uppercase italic text-pop-pink">æç¤º</h3>
                <p id="dialog-message" class="font-body font-bold text-xs mb-4">è¿™æ˜¯ä¸€æ¡æ¶ˆæ¯å†…å®¹</p>
                
                <div id="dialog-input-wrapper" class="hidden mb-4">
                    <input type="text" id="dialog-input" class="w-full border-4 border-black p-2 font-body font-bold text-sm focus:outline-none focus:bg-pop-yellow transition-colors" placeholder="è¾“å…¥å†…å®¹...">
                </div>

                <div class="flex gap-3">
                    <button id="dialog-cancel-btn" class="flex-1 py-2 border-4 border-black bg-gray-200 font-head text-xs shadow-hard-sm btn-press hidden">å–æ¶ˆ</button>
                    <button id="dialog-confirm-btn" class="flex-1 py-2 border-4 border-black bg-pop-yellow font-head text-xs shadow-hard-sm btn-press">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è§†å›¾åˆ‡æ¢é€»è¾‘ ---
        function switchView(viewId) {
            // åˆ‡æ¢å¯è§æ€§
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('view-' + viewId).classList.add('active');

            // åˆ‡æ¢å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                item.style.opacity = '0.5';
            });
            const activeNav = document.querySelector(`.nav-item[data-view="${viewId}"]`);
            activeNav.classList.add('active');
            activeNav.style.opacity = '1';

            // åˆ‡æ¢èƒŒæ™¯è‰²
            const app = document.getElementById('app');
            app.className = 'phone-frame bg-' + viewId;
        }

        // --- P2P æ ¸å¿ƒé€»è¾‘ ---
        let peer = null;
        let activeConn = null;
        let mqttClient = null;
        let publicIP = 'unknown';
        let discoveredPeers = new Map();
        let ackResolver = null; // ç”¨äºåŒæ­¥å‘é€å’Œæ¥æ”¶
        let isStealthMode = false;
        let isAutoSave = true;
        let customStoragePath = localStorage.getItem('beast_storage_path') || '';
        let directoryHandle = null; // å­˜å‚¨é€‰å®šçš„æ–‡ä»¶å¤¹å¥æŸ„
        
        // ç”Ÿæˆéšæœºå¤´åƒç§å­
        const avatarSeed = Math.random().toString(36).substr(2, 6);
        const myAvatarUrl = `https://picsum.photos/seed/${avatarSeed}/200`;
        
        // è·å–è®¾å¤‡åç§°
        function getDeviceName() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) return "å¹³æ¿è®¾å¤‡";
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated/i.test(ua)) return "ç§»åŠ¨è®¾å¤‡";
            if (/Macintosh/i.test(ua)) return "Mac ç”µè„‘";
            if (/Windows/i.test(ua)) return "Windows ç”µè„‘";
            if (/Linux/i.test(ua)) return "Linux ç”µè„‘";
            return "æœªçŸ¥è®¾å¤‡";
        }
        let myDeviceName = getDeviceName();
        let customName = null;
        
        const myIdDisplay = document.getElementById('my-peer-id');
        const fileSelector = document.getElementById('file-selector');
        const transferOverlay = document.getElementById('transfer-overlay');
        const transferFileList = document.getElementById('transfer-file-list');
        const transferInfo = document.getElementById('transfer-info');
        const transferTitle = document.getElementById('transfer-title');
        const radarMainWrapper = document.getElementById('radar-main-wrapper');
        const homepagePeersContainer = document.getElementById('homepage-peers-container');
        const homepagePeersList = document.getElementById('homepage-peers-list');
        const totalProgressContainer = document.getElementById('total-progress-container');
        const totalProgressBar = document.getElementById('total-progress-bar');
        const fileCountText = document.getElementById('file-count-text');

        // --- è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ ---
        function showCustomDialog({ title, message, isPrompt = false, isConfirm = false, defaultValue = '' }) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('custom-dialog');
                const titleEl = document.getElementById('dialog-title');
                const messageEl = document.getElementById('dialog-message');
                const inputWrapper = document.getElementById('dialog-input-wrapper');
                const input = document.getElementById('dialog-input');
                const cancelBtn = document.getElementById('dialog-cancel-btn');
                const confirmBtn = document.getElementById('dialog-confirm-btn');

                titleEl.innerText = title || 'æç¤º';
                messageEl.innerText = message || '';
                
                if (isPrompt) {
                    inputWrapper.classList.remove('hidden');
                    input.value = defaultValue;
                    cancelBtn.classList.remove('hidden');
                } else if (isConfirm) {
                    inputWrapper.classList.add('hidden');
                    cancelBtn.classList.remove('hidden');
                } else {
                    inputWrapper.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                }

                dialog.classList.remove('hidden');

                const cleanup = (value) => {
                    dialog.classList.add('hidden');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(value);
                };

                confirmBtn.onclick = () => cleanup(isPrompt ? input.value : true);
                cancelBtn.onclick = () => cleanup(false);
            });
        }

        // ç­‰å¾…æ¥æ”¶ç«¯ç¡®è®¤
        function waitForAck() {
            return new Promise(resolve => {
                ackResolver = resolve;
                // è®¾ç½®è¶…æ—¶é˜²æ­¢æ­»é”
                setTimeout(() => {
                    if (ackResolver === resolve) {
                        ackResolver = null;
                        resolve();
                    }
                }, 5000);
            });
        }

        // åˆå§‹åŒ– Peer å’Œ å‘ç°é€»è¾‘
        async function initApp() {
            // è®¾ç½®æˆ‘çš„éšæœºå¤´åƒå’Œåç§°
            document.getElementById('my-avatar-img').src = myAvatarUrl;
            document.getElementById('my-name-display').innerText = myDeviceName + ' (' + avatarSeed + ')';

            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                publicIP = data.ip.replace(/\./g, '_');
            } catch (e) {
                console.error('Failed to get IP');
            }
            initPeer();
            initDiscovery();
        }

        function initPeer() {
            const randomId = Math.random().toString(36).substr(2, 6);
            const id = 'beast-' + randomId;
            peer = new Peer(id, { debug: 1 });

            peer.on('open', (id) => {
                myIdDisplay.innerText = id;
                startBroadcasting();
            });

            peer.on('connection', (conn) => {
                setupConnection(conn);
            });

            peer.on('error', (err) => {
                console.error('Peer error:', err);
                if (err.type === 'peer-unavailable') {
                    showCustomDialog({
                        title: 'è¿æ¥å¤±è´¥',
                        message: 'è¯¥ç”¨æˆ·å¯èƒ½å·²ç¦»çº¿æˆ– ID é”™è¯¯',
                    });
                }
            });
        }

        // --- MQTT è‡ªåŠ¨å‘ç°é€»è¾‘ ---
        function initDiscovery() {
            mqttClient = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
            mqttClient.on('connect', () => {
                mqttClient.subscribe(`beast-transfer/discovery/${publicIP}`);
            });

            mqttClient.on('message', (topic, message) => {
                // å¦‚æœå¤„äºéšèº«æ¨¡å¼ï¼Œå®Œå…¨å¿½ç•¥å‘ç°çš„æ¶ˆæ¯ï¼Œæ—¢ä¸ä¿å­˜ä¹Ÿä¸æ›´æ–° UI
                if (isStealthMode) return;

                try {
                    const data = JSON.parse(message.toString());
                    if (data.id && data.id !== peer.id) {
                        discoveredPeers.set(data.id, {
                            name: data.name || 'ç¥ç§˜ç”¨æˆ·',
                            lastSeen: Date.now(),
                            avatar: data.avatar || `https://picsum.photos/seed/${data.id}/200`
                        });
                        updateDiscoveryUI();
                        if (typeof onPeerDiscovered === 'function') onPeerDiscovered();
                    }
                } catch (e) {}
            });

            setInterval(() => {
                const now = Date.now();
                let changed = false;
                for (const [id, info] of discoveredPeers.entries()) {
                    if (now - info.lastSeen > 15000) {
                        discoveredPeers.delete(id);
                        changed = true;
                    }
                }
                if (changed) updateDiscoveryUI();
            }, 10000);
        }

        function startBroadcasting() {
            if (!mqttClient || !peer || !peer.id) return;
            const broadcast = () => {
                // å¦‚æœå¼€å¯äº†éšèº«æ¨¡å¼ï¼Œä¸å‘é€å¹¿æ’­
                if (isStealthMode) return;
                
                if (mqttClient.connected) {
                    mqttClient.publish(`beast-transfer/discovery/${publicIP}`, JSON.stringify({
                        id: peer.id,
                        name: customName || myDeviceName,
                        avatar: myAvatarUrl
                    }));
                }
            };
            broadcast();
            setInterval(broadcast, 5000);
        }

        function updateDiscoveryUI() {
            // å¦‚æœå‘ç°äº†è®¾å¤‡ï¼Œç›´æ¥åœ¨ä¸»é¡µæ˜¾ç¤ºåˆ—è¡¨å®¹å™¨
            if (discoveredPeers.size > 0) {
                homepagePeersContainer.classList.remove('hidden');
                // è®©æ•´ä¸ªé›·è¾¾åŒºåŸŸï¼ˆæŒ‰é’®+æ³¢çº¹ï¼‰æ˜¾è‘—ä¸Šç§»ï¼Œå½»åº•è…¾å‡ºç©ºé—´ï¼Œé˜²æ­¢æŒ¤å‹
                radarMainWrapper.style.transform = 'translateY(-120px) scale(0.75)';
                
                // æ¸…é™¤ä¸€åˆ†é’Ÿåçš„å¼¹çª—è®¡æ—¶
                if (scanTimer) {
                    clearTimeout(scanTimer);
                    scanTimer = null;
                }
            } else {
                homepagePeersContainer.classList.add('hidden');
                radarMainWrapper.style.transform = '';
            }

            homepagePeersList.innerHTML = '';
            discoveredPeers.forEach((info, id) => {
                const isConnected = activeConn && activeConn.peer === id;
                const item = document.createElement('div');
                item.className = `flex-shrink-0 bg-white border-4 border-black p-3 shadow-hard rotate-1 hover:rotate-0 transition-all cursor-pointer group btn-press w-32 ${isConnected ? 'bg-pop-yellow' : ''}`;
                item.onclick = () => {
                    if (isConnected) {
                        fileSelector.click();
                    } else {
                        const conn = peer.connect(id);
                        setupConnection(conn);
                    }
                };
                item.innerHTML = `
                    <div class="relative mb-2">
                        <div class="w-12 h-12 border-2 border-black rounded-full overflow-hidden mx-auto">
                            <img src="${info.avatar}" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute -right-1 -top-1 w-4 h-4 ${isConnected ? 'bg-pop-blue' : 'bg-pop-green'} border-2 border-black rounded-full ${isConnected ? '' : 'animate-pulse'}"></div>
                    </div>
                    <p class="font-head text-[10px] text-center truncate uppercase mb-1">${isConnected ? 'å·²è¿æ¥' : info.name}</p>
                    <p class="font-body text-[8px] text-center text-gray-400 uppercase">${isConnected ? 'ç‚¹å‡»ä¸Šä¼ ' : 'é™„è¿‘è®¾å¤‡'}</p>
                `;
                homepagePeersList.appendChild(item);
            });
            lucide.createIcons();
        }

        function setupConnection(conn) {
            activeConn = conn;
            conn.on('open', () => {
                // è¿æ¥æˆåŠŸåï¼Œæ›´æ–°ä¸»é¡µåˆ—è¡¨ä¸­çš„çŠ¶æ€
                updateDiscoveryUI();
            });

            let receivedChunks = [];
            let metadata = null;
            let receivedBatchSize = 0;

            conn.on('data', (data) => {
                if (data.type === 'metadata') {
                    metadata = data;
                    receivedChunks = [];
                    
                    if (metadata.fileIndex === 1) {
                        transferFileList.innerHTML = '';
                        receivedBatchSize = 0;
                        transferOverlay.classList.remove('hidden');
                        transferTitle.innerText = 'æ­£åœ¨æ¥æ”¶...';
                    }
                    
                    createFileTransferItem(metadata.name, metadata.size, metadata.fileIndex);
                    fileCountText.innerText = `${metadata.fileIndex}/${metadata.totalFiles}`;
                    
                } else if (data.type === 'chunk') {
                    receivedChunks.push(data.content);
                    const currentFileProgress = Math.round((receivedChunks.length / data.totalChunks) * 100);
                    
                    let totalBatchProgress = null;
                    if (metadata.totalBatchSize) {
                        const currentReceivedSize = receivedBatchSize + (receivedChunks.length * CHUNK_SIZE);
                        totalBatchProgress = Math.round((currentReceivedSize / metadata.totalBatchSize) * 100);
                    }

                    updateTransferProgress(currentFileProgress, receivedChunks.length, data.totalChunks, metadata.size, totalBatchProgress, metadata.fileIndex);
                    
                    // æ¯ 200 ä¸ªåˆ†å—å‘é€ä¸€æ¬¡ç¡®è®¤ï¼Œå‡å°‘å¾€è¿”å¼€é”€ï¼Œå¤§å¹…æå‡é€Ÿåº¦
                    if (receivedChunks.length % 200 === 0) {
                        conn.send({ type: 'ack_chunk', count: receivedChunks.length });
                    }

                    if (receivedChunks.length === data.totalChunks) {
                        const blob = new Blob(receivedChunks);
                        
                        if (isAutoSave) {
                            downloadFile(blob, metadata.name);
                        }
                        
                        addHistoryItem(metadata.name, 'æ¥æ”¶è‡ª: ' + conn.peer, metadata.size, true, blob);
                        receivedBatchSize += metadata.size;
                        
                        // æ ‡è®°å½“å‰æ–‡ä»¶å®Œæˆ
                        const item = document.getElementById(`file-item-${metadata.fileIndex}`);
                        if (item) item.classList.add('opacity-50');
                        
                        // å‘é€æœ€ç»ˆ ACK
                        conn.send({ type: 'ack_final' });
                        
                        if (metadata.fileIndex === metadata.totalFiles) {
                            setTimeout(hideTransferOverlay, 1000);
                        }
                    }
                } else if (data.type === 'ack_chunk' || data.type === 'ack_final') {
                    if (ackResolver) {
                        ackResolver();
                        ackResolver = null;
                    }
                }
            });

            conn.on('close', () => { activeConn = null; });
        }

        // --- æ–‡ä»¶ä¼ è¾“åŠŸèƒ½ä¼˜åŒ– ---
        const CHUNK_SIZE = 163840; // æå‡åˆ° 160KBï¼Œå¹³è¡¡å…¼å®¹æ€§ä¸æé™é€Ÿåº¦
        const MAX_BUFFERED_AMOUNT = 4194304; // æå‡åˆ° 4MB ç¼“å†²é˜ˆå€¼ï¼Œé€‚åº”é«˜å¸¦å®½

        async function sendFiles(files) {
            if (!activeConn) return;
            
            const fileList = Array.from(files);
            const totalFiles = fileList.length;
            const totalBatchSize = fileList.reduce((acc, f) => acc + f.size, 0);
            let sentBatchSize = 0;

            transferFileList.innerHTML = '';
            transferOverlay.classList.remove('hidden');
            transferTitle.innerText = 'æ­£åœ¨å‘é€...';
            fileCountText.innerText = `0/${totalFiles}`;

            // åˆå§‹åŒ–æ‰€æœ‰æ–‡ä»¶é¡¹
            fileList.forEach((file, index) => {
                createFileTransferItem(file.name, file.size, index + 1);
            });

            for (let i = 0; i < totalFiles; i++) {
                const file = fileList[i];
                const fileIndex = i + 1;
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                
                activeConn.send({
                    type: 'metadata',
                    name: file.name,
                    size: file.size,
                    totalChunks: totalChunks,
                    fileIndex: fileIndex,
                    totalFiles: totalFiles,
                    totalBatchSize: totalBatchSize
                });

                fileCountText.innerText = `${fileIndex}/${totalFiles}`;

                for (let j = 0; j < totalChunks; j++) {
                    // èƒŒå‹æ§åˆ¶
                    if (activeConn.dataChannel && activeConn.dataChannel.bufferedAmount > MAX_BUFFERED_AMOUNT) {
                        await new Promise(resolve => {
                            const checkBuffer = setInterval(() => {
                                if (activeConn.dataChannel.bufferedAmount < MAX_BUFFERED_AMOUNT / 2) {
                                    clearInterval(checkBuffer);
                                    resolve();
                                }
                            }, 50);
                        });
                    }

                    const start = j * CHUNK_SIZE;
                    const end = Math.min(file.size, start + CHUNK_SIZE);
                    const chunk = file.slice(start, end);
                    const arrayBuffer = await chunk.arrayBuffer();
                    
                    activeConn.send({
                        type: 'chunk',
                        content: arrayBuffer,
                        currentChunk: j + 1,
                        totalChunks: totalChunks
                    });

                    // æ¯ 200 ä¸ªå—å¼ºåˆ¶åŒæ­¥ä¸€æ¬¡ï¼Œå…¼é¡¾é€Ÿåº¦ä¸ç¨³å®šæ€§
                    if ((j + 1) % 200 === 0) {
                        await waitForAck();
                    }

                    const currentFileProgress = Math.round(((j + 1) / totalChunks) * 100);
                    const currentSentSize = sentBatchSize + end;
                    const totalBatchProgress = Math.round((currentSentSize / totalBatchSize) * 100);
                    
                    updateTransferProgress(currentFileProgress, j + 1, totalChunks, file.size, totalBatchProgress, fileIndex);
                }

                await waitForAck();
                sentBatchSize += file.size;
                
                // æ ‡è®°å®Œæˆ
                const item = document.getElementById(`file-item-${fileIndex}`);
                if (item) item.classList.add('opacity-50');
                
                addHistoryItem(file.name, 'å‘é€è‡³: ' + activeConn.peer, file.size, true);
            }

            setTimeout(hideTransferOverlay, 1000);
        }

        function createFileTransferItem(name, size, index) {
            const sizeStr = (size / (1024 * 1024)).toFixed(2) + 'MB';
            const item = document.createElement('div');
            item.id = `file-item-${index}`;
            item.className = "bg-gray-50 border-2 border-black p-2 shadow-hard-sm transition-opacity";
            item.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <p class="font-head text-[10px] truncate w-2/3 uppercase">${name}</p>
                    <p class="font-body font-bold text-[8px] opacity-60">${sizeStr}</p>
                </div>
                <div class="w-full h-2 border-2 border-black bg-white relative overflow-hidden">
                    <div id="file-progress-${index}" class="absolute inset-y-0 left-0 bg-pop-pink transition-all duration-300" style="width: 0%"></div>
                </div>
            `;
            transferFileList.appendChild(item);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            transferFileList.scrollTop = transferFileList.scrollHeight;
        }

        async function downloadFile(blob, filename) {
            // ä¼˜å…ˆå°è¯•ä¿å­˜åˆ°ç”¨æˆ·é€‰å®šçš„æ–‡ä»¶å¤¹
            if (directoryHandle) {
                try {
                    const fileHandle = await directoryHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    console.log(`æ–‡ä»¶ ${filename} å·²ç›´æ¥ä¿å­˜åˆ°é€‰å®šç›®å½•`);
                    return;
                } catch (err) {
                    console.error('ä¿å­˜åˆ°ç›®å½•å¤±è´¥ï¼Œå°†é€€å›åˆ°æ™®é€šä¸‹è½½', err);
                }
            }

            // é€€å›åˆ°æ™®é€šä¸‹è½½
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // å¦‚æœè®¾ç½®äº†è‡ªå®šä¹‰è·¯å¾„å‰ç¼€ (ç§»åŠ¨ç«¯é€€è€Œæ±‚å…¶æ¬¡çš„æ–¹æ¡ˆ)
            const finalFilename = customStoragePath 
                ? `${customStoragePath}_${filename}` 
                : filename;
                
            a.download = finalFilename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // --- UI è¾…åŠ©å‡½æ•° ---
        function showTransferOverlay(title, progress) {
            transferOverlay.classList.remove('hidden');
            transferTitle.innerText = title;
        }

        function updateTransferProgress(progress, current, total, totalSize, totalBatchProgress, fileIndex) {
            // æ›´æ–°å•ä¸ªæ–‡ä»¶è¿›åº¦
            const fileBar = document.getElementById(`file-progress-${fileIndex}`);
            if (fileBar) fileBar.style.width = progress + '%';

            // æ›´æ–°æ€»è¿›åº¦
            if (totalBatchProgress !== null) {
                totalProgressBar.style.width = totalBatchProgress + '%';
                const totalProgressText = totalBatchProgress + '%';
                const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
                transferInfo.innerText = `${totalProgressText} - å½“å‰æ–‡ä»¶: ${progress}% (${sizeInMB} MB)`;
            }
        }

        function hideTransferOverlay() {
            transferOverlay.classList.add('hidden');
        }

        function addHistoryItem(name, desc, size, success, blob = null) {
            const logsContainer = document.getElementById('history-list');
            const sizeStr = (size / (1024 * 1024)).toFixed(2) + 'MB';
            
            const item = document.createElement('div');
            item.className = `bg-white border-4 border-black p-0 shadow-hard hover:translate-x-1 transition-transform relative overflow-hidden group cursor-pointer`;
            
            // å¦‚æœæœ‰ blob ä¸”æ²¡æœ‰è‡ªåŠ¨ä¿å­˜ï¼Œå…è®¸ç‚¹å‡»ä¸‹è½½
            if (blob && !isAutoSave) {
                item.onclick = () => downloadFile(blob, name);
                desc += ' (ç‚¹å‡»æ‰‹åŠ¨ä¸‹è½½)';
            }

            item.innerHTML = `
                <div class="absolute top-0 bottom-0 left-0 w-3 ${success ? 'bg-pop-green' : 'bg-red-500'} group-hover:w-full transition-all duration-300 ease-out z-0"></div>
                <div class="relative z-10 flex p-4 gap-4 items-center group-hover:text-white transition-colors">
                    <div class="w-12 h-12 bg-black border-2 border-black flex-shrink-0 flex items-center justify-center">
                        <span class="text-2xl">${name.match(/\.(jpg|jpeg|png|gif)$/i) ? 'ğŸ“¸' : 'ğŸ“„'}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-head text-lg truncate leading-none">${name}</h3>
                        <p class="font-body text-xs font-bold mt-1 opacity-70 uppercase">${desc}</p>
                    </div>
                    <div class="font-head text-sm">${sizeStr}</div>
                </div>
            `;
            logsContainer.insertBefore(item, logsContainer.children[1]);
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        const scanBtn = document.getElementById('scan-btn');
        const idInputContainer = document.getElementById('id-input-container');
        const peerIdInput = document.getElementById('peer-id-input');
        const scanBtnContainer = document.getElementById('scan-btn-container');
        let scanTimer = null;

        // æ‰«ææŒ‰é’®ç‚¹å‡»
        scanBtn.addEventListener('click', () => {
            // å¦‚æœå¼€å¯äº†éšèº«æ¨¡å¼ï¼Œç¦æ­¢ä¸»åŠ¨æ‰«æ
            if (isStealthMode) {
                showCustomDialog({
                    title: 'æ¨¡å¼å†²çª',
                    message: 'æ‚¨å½“å‰å¤„äºâ€œéšèº«æ¨¡å¼â€ï¼Œæ— æ³•ä¸»åŠ¨æ‰«æä»–äººã€‚è¯·å…ˆåœ¨è®¾ç½®ä¸­å…³é—­éšèº«æ¨¡å¼ã€‚'
                });
                return;
            }

            const ripples = document.querySelectorAll('.ripple');
            ripples.forEach(r => r.style.animationDuration = '1s');
            document.getElementById('scan-text').innerText = 'æœç´¢ä¸­...';
            
            // å¦‚æœå·²ç»åœ¨è®¡æ—¶ï¼Œå…ˆæ¸…é™¤
            if (scanTimer) clearTimeout(scanTimer);

            // ä¸€åˆ†é’Ÿï¼ˆ60000msï¼‰åæ£€æŸ¥
            scanTimer = setTimeout(() => {
                // å¦‚æœä¸€åˆ†é’Ÿåä¾ç„¶æ²¡æœ‰å‘ç°ä»»ä½•è®¾å¤‡ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©º
                if (discoveredPeers.size === 0) {
                    scanBtnContainer.classList.add('opacity-20', 'pointer-events-none');
                    idInputContainer.classList.remove('hidden');
                    updateDiscoveryUI();
                    document.getElementById('scan-text').innerText = 'æ‰«æ';
                    const ripples = document.querySelectorAll('.ripple');
                    ripples.forEach(r => r.style.animationDuration = '3s');
                }
            }, 60000); 

            // æ³¨æ„ï¼šè¿™é‡Œä¸å†ç«‹å³å¼¹å‡º idInputContainer.classList.remove('hidden')
        });

        // ç›‘å¬è®¾å¤‡å‘ç°ï¼Œå¦‚æœå‘ç°äº†è®¾å¤‡ï¼Œå¯ä»¥è€ƒè™‘è‡ªåŠ¨åœæ­¢è®¡æ—¶æˆ–æ›´æ–° UI
        function onPeerDiscovered() {
            // å¦‚æœå‘ç°äº†è®¾å¤‡ï¼Œä¸”è®¡æ—¶å™¨è¿˜åœ¨è·‘ï¼Œå¯ä»¥è€ƒè™‘åœ¨è¿™é‡Œåšä¸€äº›è§†è§‰åé¦ˆ
            // ä½†æ ¹æ®éœ€æ±‚ï¼Œåªè¦å‘ç°äº†è®¾å¤‡ï¼Œå°±ä¸åº”è¯¥åœ¨ä¸€åˆ†é’Ÿåå¼¹å‡ºè¾“å…¥æ¡†
            if (scanTimer && discoveredPeers.size > 0) {
                // æš‚æ—¶ä¸æ¸…é™¤è®¡æ—¶å™¨ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æƒ³ç»§ç»­æœç´¢ï¼Œä½†ç”±äºåˆ—è¡¨ä¸ä¸ºç©ºï¼Œè®¡æ—¶å™¨è§¦å‘æ—¶ä¹Ÿä¸ä¼šå¼¹çª—
            }
        }

        // è¿æ¥ç¡®è®¤
        document.getElementById('connect-confirm-btn').addEventListener('click', () => {
            const targetId = peerIdInput.value.trim();
            if (targetId && peer) {
                const conn = peer.connect(targetId);
                setupConnection(conn);
                idInputContainer.classList.add('hidden');
                scanBtnContainer.classList.remove('opacity-20', 'pointer-events-none');
                document.getElementById('scan-text').innerText = 'æ‰«æ';
                const ripples = document.querySelectorAll('.ripple');
                ripples.forEach(r => r.style.animationDuration = '3s');
            }
        });

        // å–æ¶ˆè¿æ¥
        document.getElementById('connect-cancel-btn').addEventListener('click', () => {
            idInputContainer.classList.add('hidden');
            radarMainWrapper.style.transform = '';
            document.getElementById('scan-text').innerText = 'æ‰«æ';
            const ripples = document.querySelectorAll('.ripple');
            ripples.forEach(r => r.style.animationDuration = '3s');
        });

        // æ–‡ä»¶é€‰æ‹©åå‘é€
        fileSelector.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0 && activeConn) {
                sendFiles(files);
            }
        });

        // å¤åˆ¶ ID
        document.getElementById('copy-id-btn').addEventListener('click', () => {
            const id = myIdDisplay.innerText;
            navigator.clipboard.writeText(id).then(() => {
                showCustomDialog({
                    title: 'æˆåŠŸ',
                    message: 'ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!'
                });
            });
        });

        // ç¼–è¾‘åç§°
        document.getElementById('edit-name-btn').addEventListener('click', async () => {
            const newName = await showCustomDialog({
                title: 'ä¿®æ”¹åç§°',
                message: 'è¯·è¾“å…¥æ–°çš„è®¾å¤‡åç§°:',
                isPrompt: true,
                defaultValue: customName || myDeviceName
            });
            
            if (newName && newName.trim() !== '') {
                customName = newName.trim();
                document.getElementById('my-name-display').innerText = customName + ' (' + avatarSeed + ')';
                // ç«‹å³å¹¿æ’­ä¸€æ¬¡æ–°åç§°
                if (mqttClient && mqttClient.connected) {
                    mqttClient.publish(`beast-transfer/discovery/${publicIP}`, JSON.stringify({
                        id: peer.id,
                        name: customName,
                        avatar: myAvatarUrl
                    }));
                }
            }
        });

        // å¯åŠ¨åˆå§‹åŒ–
        initApp();
        lucide.createIcons();

        // æŒ‰é’®ç‚¹å‡»é€šç”¨åé¦ˆ
        document.querySelectorAll('.btn-press, .nav-item').forEach(el => {
            el.addEventListener('mousedown', function() {
                this.style.transform = 'scale(0.95) ' + (this.classList.contains('nav-item') && this.classList.contains('active') ? 'translateY(-5px) rotate(-3deg)' : '');
            });
            el.addEventListener('mouseup', function() { this.style.transform = ''; });
            el.addEventListener('mouseleave', function() { this.style.transform = ''; });
        });

        // Toggle Switch é€»è¾‘
        document.querySelectorAll('.toggle-switch').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const isActive = this.getAttribute('data-active') === 'true';
                const newActive = !isActive;
                this.setAttribute('data-active', newActive);
                const knob = this.querySelector('.toggle-knob');
                
                // æ›´æ–°å†…éƒ¨çŠ¶æ€
                if (this.id === 'stealth-mode-toggle') {
                    isStealthMode = newActive;
                    const statusEl = document.getElementById('lan-mode-status');
                    
                    if (isStealthMode) {
                        // å¼€å¯éšèº«æ—¶
                        if (statusEl) {
                            statusEl.innerText = 'å±€åŸŸç½‘æ¨¡å¼: éšèº«';
                            statusEl.classList.replace('text-pop-green', 'text-red-500');
                        }
                        
                        // æ¸…é™¤å·²å‘ç°åˆ—è¡¨å¹¶é‡ç½® UI
                        discoveredPeers.clear();
                        updateDiscoveryUI();
                        
                        const ripples = document.querySelectorAll('.ripple');
                        ripples.forEach(r => r.style.animationDuration = '3s');
                        document.getElementById('scan-text').innerText = 'æ‰«æ';
                        if (scanTimer) {
                            clearTimeout(scanTimer);
                            scanTimer = null;
                        }
                        homepagePeersContainer.classList.add('hidden');
                        radarMainWrapper.style.transform = '';
                    } else {
                        // å…³é—­éšèº«æ—¶
                        if (statusEl) {
                            statusEl.innerText = 'å±€åŸŸç½‘æ¨¡å¼: å¼€å¯';
                            statusEl.classList.replace('text-red-500', 'text-pop-green');
                        }
                    }
                } else if (this.id === 'auto-save-toggle') {
                    isAutoSave = newActive;
                }

                if (newActive) {
                    this.classList.replace('bg-black', 'bg-pop-yellow');
                    knob.classList.replace('left-1', 'right-1');
                    knob.classList.replace('bg-pop-pink', 'bg-white');
                } else {
                    this.classList.replace('bg-pop-yellow', 'bg-black');
                    knob.classList.replace('right-1', 'left-1');
                    knob.classList.replace('bg-white', 'bg-pop-pink');
                }
            });
        });

        // å­˜å‚¨è·¯å¾„ç‚¹å‡»
        document.getElementById('storage-path-btn').addEventListener('click', async () => {
            if ('showDirectoryPicker' in window) {
                // å¦‚æœæµè§ˆå™¨æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹© API (é€šå¸¸æ˜¯æ¡Œé¢ç«¯ Chrome/Edge)
                try {
                    directoryHandle = await window.showDirectoryPicker();
                    // æ£€æŸ¥å¹¶è¯·æ±‚è¯»å†™æƒé™
                    const options = { mode: 'readwrite' };
                    if ((await directoryHandle.queryPermission(options)) !== 'granted') {
                        if ((await directoryHandle.requestPermission(options)) !== 'granted') {
                            directoryHandle = null;
                            showCustomDialog({ title: 'å¤±è´¥', message: 'æœªè·å¾—æ–‡ä»¶å¤¹è¯»å†™æƒé™ã€‚' });
                            return;
                        }
                    }
                    showCustomDialog({ 
                        title: 'è®¾ç½®æˆåŠŸ', 
                        message: `å·²æˆåŠŸç»‘å®šæ–‡ä»¶å¤¹ã€‚æ¥æ”¶çš„æ–‡ä»¶å°†ç›´æ¥ä¿å­˜åˆ°è¯¥ä½ç½®ï¼` 
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error(err);
                        showCustomDialog({ title: 'é”™è¯¯', message: 'æ— æ³•é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œè¯·é‡è¯•ã€‚' });
                    }
                }
            } else {
                // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ (å¦‚æ‰‹æœºç«¯ Safari/Chrome)
                const ua = navigator.userAgent;
                let mobileMsg = '';
                if (/iPhone|iPad|iPod/i.test(ua)) {
                    mobileMsg = 'iOS ç³»ç»Ÿå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸å…è®¸ç½‘é¡µç›´æ¥æ§åˆ¶æ–‡ä»¶å¤¹ã€‚æ–‡ä»¶å°†è‡ªåŠ¨ä¿å­˜åˆ°â€œæ–‡ä»¶â€App çš„â€œä¸‹è½½â€ç›®å½•ä¸­ã€‚';
                } else if (/Android/i.test(ua)) {
                    mobileMsg = 'Android ç³»ç»Ÿæš‚ä¸æ”¯æŒç½‘é¡µç›´æ¥é€‰æ‹©å­˜å‚¨ç›®å½•ã€‚æ–‡ä»¶å°†è‡ªåŠ¨ä¿å­˜åˆ°æ‚¨çš„â€œç³»ç»Ÿä¸‹è½½ (Download)â€æ–‡ä»¶å¤¹ä¸­ã€‚';
                } else {
                    mobileMsg = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹ã€‚æ–‡ä»¶å°†ä¿å­˜åˆ°é»˜è®¤ä¸‹è½½ä½ç½®ã€‚';
                }
                
                showCustomDialog({ title: 'ç³»ç»Ÿé™åˆ¶', message: mobileMsg });
            }
        });
    </script>
</body>
</html>
